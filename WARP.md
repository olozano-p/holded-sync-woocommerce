# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.
``

Project: holded-sync (Node.js ESM)

Commands
- One-time setup (creates logs/exports, checks Node >=18, installs deps):
  - bash setup.sh
- Install dependencies:
  - npm install
- Full sync (products + yesterday’s sales by default):
  - npm run sync
- Products only:
  - npm run sync:products
- Sales only (date range optional):
  - npm run sync:sales [--from YYYY-MM-DD --to YYYY-MM-DD]
- Excel exports only (no Holded API calls):
  - npm run export
- Direct CLI with help:
  - node src/index.js --help

Scheduling (choose one)
- Cron (8:00 AM daily): add this line via crontab -e
  - 0 8 * * * cd /absolute/path/to/holded-sync && node src/index.js >> logs/sync.log 2>&1
- systemd timer (see systemd/):
  1) Edit WorkingDirectory and paths in systemd/holded-sync.service
  2) sudo cp systemd/holded-sync.* /etc/systemd/system/
  3) sudo systemctl daemon-reload && sudo systemctl enable --now holded-sync.timer

Environment and configuration
- Copy env template and fill credentials:
  - cp .env.example .env
- Required at minimum: HOLDED_API_KEY and either at least one WooCommerce site (WC_SITEx_*) or SUMUP_API_KEY. Optional tuning in .env: HOLDED_DOC_TYPE, HOLDED_NUMBERING_FORMAT, DEFAULT_VAT_RATE, SYNC_DAYS_BACK, LOG_LEVEL, TZ, HOLDED_SALES_CHANNEL, HOLDED_WAREHOUSE.
- Node >= 18 is required (enforced by setup.sh and package.json engines).

Outputs and logs
- Logs: logs/sync.log (info), logs/error.log (errors). Created by setup.sh or on first run.
- Excel exports (Holded-compatible): exports/*.xlsx generated by exportProductsToExcel/exportOrdersToExcel.

High-level architecture
- Orchestrator: src/index.js
  - Parses CLI flags, validates configuration, computes date ranges, and coordinates the sync.
  - Two independent flows: products and sales. Both always export Excel; Holded API calls are skipped when --excel-only is set.
- Configuration: src/config.js
  - Loads .env (dotenv). Shapes config for Holded, WooCommerce (array of sites), SumUp, sync defaults, logging. validateConfig() enforces presence of keys and exits on fatal misconfig.
- Sources (data ingestion): src/sources/
  - woocommerce.js
    - WooCommerceClient wraps @woocommerce/woocommerce-rest-api, handles pagination for products and orders, normalizes to internal product/order shapes (prefixing SKUs, deriving tax rates, mapping customer/address fields, computing paid flag).
  - sumup.js
    - SumUpClient wraps axios against SumUp history endpoint, handles pagination via oldest_ref, normalizes transactions into order-like shape with a single line item.
- Destinations (persistence/exports): src/destinations/
  - holded.js (HoldedClient)
    - Axios client with API key header.
    - Startup caches: existing products, sales channels, warehouses, payment methods.
    - Products: createOrUpdateProduct() is idempotent per-SKU; syncProducts() batches with light rate limiting.
    - Contacts: findOrCreateContact() searches by email/name/VAT and creates if missing.
    - Documents: createInvoice() builds Holded document payload from normalized orders; payDocument() optionally marks as paid; syncOrders() initializes caches then iterates with rate limiting.
  - excel.js
    - Exports two Holded-import-compatible workbooks:
      - Productos: columns match Importar_Productos.xlsx; SKU is site-prefixed.
      - Facturas: 32-column layout matching Importar_Facturas_emitidas.xlsx; one row per line item, repeated header fields on first item row only. Also writes a human-readable Resumen Ventas sheet.
- Utilities: src/utils/
  - logger.js: winston logger to console + files with timestamps; level from LOG_LEVEL.
  - date.js: helpers for YYYY-MM-DD ranges and dd/mm/yyyy formatting for Holded import.

Data flow (big picture)
- Products
  1) For each configured WooCommerce site → fetch and normalize products
  2) Always export to Excel (exports/productos_YYYY-MM-DD.xlsx)
  3) If not --excel-only → upsert into Holded by SKU
- Sales
  1) For date range → fetch WooCommerce orders and SumUp transactions in parallel and normalize
  2) Always export invoices Excel (exports/facturas_YYYY-MM-DD.xlsx) and a sales summary workbook
  3) If not --excel-only → create Holded documents (invoice by default) and optionally mark paid

Conventions and operational notes
- Idempotency: WooCommerce product SKUs are site-prefixed to avoid collisions; Holded upserts by existingProducts cache. Sales create new documents per run; invoice numbering follows Holded server-side rules when using API, while Excel exports use a simple F[YY]%%%% sequence for manual import.
- Pagination and rate-limiting: WooCommerce and SumUp sources page in 100s; Holded writes are throttled (100–200 ms sleeps) to be conservative.
- Error behavior: Fatal config errors exit(1). Sync aggregates per-section counts and exits non-zero if any errors occurred to signal CI/cron failures.
